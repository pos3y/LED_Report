<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Performance Report</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .tab-btn.active { background-color: #065f46; color: white; border-color: #065f46; }
        .hidden { display: none !important; }
        #loading { position: fixed; inset: 0; background: white; z-index: 999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        iframe { width: 100%; height: 100%; }
    </style>
</head>
<body>

    <div id="loading">
        <i class="fa-solid fa-circle-notch fa-spin text-4xl text-emerald-600 mb-4"></i>
        <p class="text-gray-500">Connecting to Database...</p>
    </div>

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden border border-gray-200">
                    <img id="header-logo" class="w-full h-full object-contain hidden" onerror="this.style.display='none'"> 
                    <i id="header-icon" class="fa-solid fa-chart-simple text-emerald-800 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight uppercase" id="brand-title">...</h1>
                    <p class="text-sm text-gray-500">Monthly Performance Report</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 px-3 py-2 rounded-lg">
                <i class="fa-solid fa-calendar-days text-emerald-600"></i>
                <select id="monthSelector" class="bg-transparent font-bold text-gray-700 outline-none cursor-pointer" onchange="changeMonth()"></select>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-6xl">
        <div id="error-msg" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"></div>

        <div id="main-content" class="hidden">
            <div class="mb-8">
                <h2 class="text-gray-500 text-sm mb-3 font-semibold uppercase tracking-wider">Select Slot</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="tab-container"></div>
            </div>

            <div class="animate-fade-in">
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-gray-800">
                        <div class="text-gray-400 text-xs uppercase font-bold">Slot ID</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1" id="val-slot">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-emerald-500">
                        <div class="text-gray-400 text-xs uppercase font-bold">Impression</div>
                        <div class="text-2xl font-bold text-emerald-600 mt-1" id="val-imp">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-400">
                        <div class="text-gray-400 text-xs uppercase font-bold">Total Hours</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1" id="val-hr">--</div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-indigo-500">
                        <div class="text-gray-400 text-xs uppercase font-bold">Media Time</div>
                        <div class="text-2xl font-bold text-gray-800 mt-1" id="val-dur">--</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    
                    <div class="bg-white p-4 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700"><i class="fa-solid fa-play-circle text-emerald-600 mr-2"></i>Media Preview (สื่อโฆษณา)</h3>
                        </div>
                        <div class="aspect-video bg-black rounded-lg overflow-hidden flex items-center justify-center relative group">
                            <video id="main-video" class="w-full h-full object-contain hidden" controls autoplay muted loop playsinline><source src="" type="video/mp4"></video>
                            <iframe id="youtube-frame" class="hidden" src="" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                            <img id="main-image" class="w-full h-full object-contain hidden" src="">
                            
                            <div id="media-loader" class="absolute inset-0 flex items-center justify-center bg-gray-900 text-white flex-col hidden">
                                <i class="fa-solid fa-circle-notch fa-spin text-2xl"></i>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400 text-center truncate" id="media-source-text"></div>
                    </div>

                    <div class="bg-white p-4 rounded-xl shadow-sm flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-bold text-gray-700"><i class="fa-solid fa-camera text-emerald-600 mr-2"></i>Shelf Photo (รูปจอในร้าน)</h3>
                        </div>
                        <div class="relative bg-gray-100 rounded-lg overflow-hidden flex-1 min-h-[300px]">
                            <img id="shelf-display-img" src="" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/600x400?text=No+Shelf+Photo'">
                            <div class="absolute bottom-4 right-4 bg-black/70 text-white text-xs px-3 py-1 rounded-full backdrop-blur-sm">
                                <i class="fa-solid fa-check-circle mr-1 text-green-400"></i> Active Location
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm break-inside-avoid">
                    <div class="flex items-center gap-2 mb-4 border-b border-gray-100 pb-2">
                        <i class="fa-solid fa-map-location-dot text-emerald-600 text-xl"></i>
                        <h3 class="font-bold text-gray-700 text-lg">Store Map Overview (ผังร้านค้า)</h3>
                    </div>
                    
                    <div class="w-full bg-gray-50 rounded-lg overflow-hidden border border-gray-100 flex justify-center">
                        <img id="map-display-img" src="" class="w-full h-auto object-contain max-h-[600px]" onerror="this.src='https://placehold.co/1000x400?text=No+Store+Map+Available'">
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script>
        // ==========================================
        //  CSV Link ของคุณ
        // ==========================================
        const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPt5_VqUQSurUF8zod1Ns67QBSMvPhFwpuwvniE8wzX3dDOrXyxClrDywMwMnkaJ-Ite1M3DlLeTZt/pub?output=csv"; 
        // ==========================================

        let currentBrandData = {};
        let currentSlots = [];
        let currentSlotData = null; 

        function cleanNumber(val) {
            if (!val) return 0;
            const clean = String(val).replace(/,/g, '').trim();
            const num = Number(clean);
            return isNaN(num) ? 0 : num;
        }

        function processMediaLink(url) {
            if (!url) return { type: 'none', url: '' };
            url = url.trim();
            
            if (url.includes("drive.google.com") && url.includes("/d/")) {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) return { type: 'drive', url: `https://drive.google.com/uc?export=view&id=${idMatch[1]}` };
            }
            if (url.includes("youtube.com") || url.includes("youtu.be")) {
                let videoId = "";
                if (url.includes("v=")) videoId = url.split("v=")[1].split("&")[0];
                else if (url.includes("youtu.be/")) videoId = url.split("youtu.be/")[1].split("?")[0];
                if (videoId) return { type: 'youtube', url: `https://www.youtube.com/embed/${videoId}?autoplay=1&mute=1&loop=1&playlist=${videoId}` };
            }
            if (url.match(/\.(mp4|webm|mov)$/i)) return { type: 'video', url: url };
            
            return { type: 'image', url: url };
        }

        function convertDriveLink(url) {
            if (!url) return "";
            url = url.trim();
            if (url.includes("drive.google.com") && url.includes("/d/")) {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) return `https://drive.google.com/uc?export=view&id=${idMatch[1]}`;
            }
            return url;
        }

        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const brandID = urlParams.get('brand');
            if (!brandID) { showError("Error: No Brand ID specified in URL (e.g., ?brand=terra)"); return; }

            document.getElementById('brand-title').innerText = brandID;
            fetchData(brandID);
        };

        function fetchData(brandID) {
            Papa.parse(SHEET_CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    const rows = results.data;
                    const filtered = rows.filter(row => row.Brand_ID && row.Brand_ID.toLowerCase().trim() === brandID.toLowerCase().trim());

                    if (filtered.length === 0) { showError("No data found for brand: " + brandID); return; }

                    if (filtered[0].Brand_Logo_URL) {
                        const logoMedia = processMediaLink(filtered[0].Brand_Logo_URL);
                        const logoImg = document.getElementById('header-logo');
                        document.getElementById('header-icon').classList.add('hidden');
                        logoImg.src = logoMedia.url;
                        logoImg.classList.remove('hidden');
                    }

                    currentBrandData = filtered.reduce((acc, row) => {
                        const month = row.Month.trim();
                        if (!acc[month]) acc[month] = [];
                        acc[month].push(row);
                        return acc;
                    }, {});

                    initSystem();
                },
                error: function() { showError("Connection Error: Cannot load Google Sheet."); }
            });
        }

        function initSystem() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            const selector = document.getElementById('monthSelector');
            const months = Object.keys(currentBrandData);
            if(months.length === 0) return;
            months.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m;
                opt.innerText = m.toUpperCase();
                selector.appendChild(opt);
            });
            changeMonth();
        }

        function changeMonth() {
            const monthKey = document.getElementById('monthSelector').value;
            currentSlots = currentBrandData[monthKey];
            renderTabs();
            loadSlot(0);
        }

        function renderTabs() {
            const container = document.getElementById('tab-container');
            container.innerHTML = '';
            currentSlots.forEach((item, index) => {
                const btn = document.createElement('button');
                btn.className = `tab-btn p-4 rounded-xl border-2 border-gray-200 bg-white hover:border-emerald-400 transition text-left w-full`;
                btn.onclick = () => loadSlot(index);
                btn.id = `tab-${index}`;
                btn.innerHTML = `<div class="font-bold text-lg">${item.Slot_ID}</div><div class="text-sm text-gray-400 mt-1">${item.Slot_Name || 'Display Slot'}</div>`;
                container.appendChild(btn);
            });
        }

        function loadSlot(index) {
            currentSlotData = currentSlots[index];
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${index}`).classList.add('active');

            // Metrics
            document.getElementById('val-slot').innerText = currentSlotData.Slot_ID;
            document.getElementById('val-imp').innerText = cleanNumber(currentSlotData.Impression).toLocaleString();
            document.getElementById('val-hr').innerText = currentSlotData.Hours || '-';
            document.getElementById('val-dur').innerText = currentSlotData.Media_Duration || '-';

            // 1. Media Player
            const vdo = document.getElementById('main-video');
            const yt = document.getElementById('youtube-frame');
            const img = document.getElementById('main-image');
            const srcText = document.getElementById('media-source-text');
            
            vdo.classList.add('hidden'); vdo.pause();
            yt.classList.add('hidden'); yt.src = "";
            img.classList.add('hidden');

            const mediaData = processMediaLink(currentSlotData.Media_Source_URL);
            srcText.innerText = "Source: " + (currentSlotData.Media_Source_URL ? "Loaded" : "None");

            if (mediaData.type === 'youtube') {
                yt.src = mediaData.url; yt.classList.remove('hidden');
            } else if (mediaData.type === 'video' || mediaData.type === 'drive') {
                vdo.src = mediaData.url; vdo.classList.remove('hidden');
                vdo.onerror = () => { vdo.classList.add('hidden'); img.src = mediaData.url; img.classList.remove('hidden'); };
            } else {
                img.src = mediaData.url; img.classList.remove('hidden');
            }

            // 2. Shelf Photo
            const shelfImg = document.getElementById('shelf-display-img');
            const shelfUrl = convertDriveLink(currentSlotData.Shelf_Photo_URL);
            shelfImg.src = shelfUrl || "https://placehold.co/600x400?text=No+Shelf+Photo";

            // 3. Store Map
            const mapImg = document.getElementById('map-display-img');
            const mapUrl = convertDriveLink(currentSlotData.Store_Map_URL);
            mapImg.src = mapUrl || "https://placehold.co/1000x400?text=No+Store+Map";
        }

        function showError(msg) {
            document.getElementById('loading').classList.add('hidden');
            const box = document.getElementById('error-msg');
            box.innerText = msg;
            box.classList.remove('hidden');
        }
    </script>
</body>
</html>
